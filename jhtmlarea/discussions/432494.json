[
  {
    "Id": "998558",
    "ThreadId": "432494",
    "Html": "Hello,<br />\n<br />\nI am trying to integrate an ajax &quot;drag and drop&quot; image upload function for jHtmlArea and got as far as having a separate &quot;drop box&quot; above the toolbar.<br />\n<br />\nWhen an image file is dropped there it is uploaded and the resulting image link is pasted as html into jHtmlArea.<br />\n<br />\nWhat would be much nicer is if one could drop the image directly into the text area.<br />\n<br />\nWould anyone be able to give a hint as to how to achieve this?<br />\n<br />\nThe upload box is adapted from code by Eric Potvin: <br />\n<br />\n<a href=\"http://www.bookofzeus.com/articles/drag-and-drop-upload-files-using-ajax\" rel=\"nofollow\">http://www.bookofzeus.com/articles/drag-and-drop-upload-files-using-ajax</a><br />\n<br />\n <br />\nHere is the html page source:<br />\n<pre><code>&lt;!DOCTYPE html&gt;\n&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;\n&lt;head&gt;\n    &lt;title&gt;Test Picture Drop and Upload for jHTMLarea&lt;/title&gt;\n    &lt;script type=&quot;text/javascript&quot; src=&quot;scripts/jquery-1.7.2.min.js&quot;&gt;&lt;/script&gt;\n    &lt;script type=&quot;text/javascript&quot; src=&quot;scripts/jquery-ui-1.7.2.custom.min.js&quot;&gt;&lt;/script&gt;\n    &lt;link rel=&quot;Stylesheet&quot; type=&quot;text/css&quot; href=&quot;style/jqueryui/ui-lightness/jquery-ui-1.7.2.custom.css&quot; /&gt;\n &lt;script src=&quot;scripts/bozupload.js&quot;&gt;&lt;/script&gt;\n &lt;link rel=&quot;stylesheet&quot; href=&quot;style/bozupload.css&quot; /&gt;\n    &lt;script type=&quot;text/javascript&quot; src=&quot;scripts/jHtmlArea-0.7.5.js&quot;&gt;&lt;/script&gt;\n    &lt;link rel=&quot;Stylesheet&quot; type=&quot;text/css&quot; href=&quot;style/jHtmlArea.css&quot; /&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;script type=&quot;text/javascript&quot;&gt;\n        $(function() {\n            $(&quot;#jhtmlarea&quot;).htmlarea({\n                toolbar: [\n                    [&quot;html&quot;,&quot;bold&quot;, &quot;italic&quot;, &quot;underline&quot;],\n                    [&quot;p&quot;, &quot;h1&quot;, &quot;h2&quot;, &quot;h3&quot;, &quot;h4&quot;, &quot;h5&quot;, &quot;h6&quot;],\n                    [&quot;link&quot;, &quot;unlink&quot;],                    \n                 ],\n        });\n   });     \n    &lt;/script&gt;\n&lt;div align=right  style=&quot;width:360px;&quot;&gt;&lt;section id=&quot;uploadBox&quot;&gt;drop image&lt;br /&gt;here&lt;/section&gt;&lt;/div&gt;\n    \n&lt;textarea id=&quot;jhtmlarea&quot; cols=&quot;120&quot; rows=&quot;60&quot;&gt;&lt;p&gt;&lt;h3&gt;Test H3&lt;/h3&gt;This is some sample text to test out the &lt;b&gt;WYSIWYG Control&lt;/b&gt;.&lt;/p&gt;&lt;/textarea&gt;\n        \n&lt;div id=&quot;modal&quot;&gt;\n     &lt;div id=&quot;modalMask&quot;&gt;&lt;/div&gt;\n     &lt;div id=&quot;modalContent&quot;&gt;\n       &lt;section id=&quot;uploadStatus&quot;&gt;\n         &lt;div id=&quot;progressWrapper&quot;&gt;\n             &lt;div id=&quot;progressBar&quot;&gt;&lt;/div&gt;\n             &lt;div id=&quot;progressValue&quot;&gt;0%&lt;/div&gt;\n             &lt;p&gt;Processing, please wait ... &lt;input type=&quot;button&quot; id=&quot;closeModal&quot; value=&quot;Close&quot;&gt;\n         &lt;/div&gt;\n        &lt;/section&gt;\n     &lt;/div&gt;\n&lt;/div&gt;\n &lt;/body&gt;\n&lt;/html&gt;</code></pre>\n\nhere is the code of the uploader.php that receives the image file on the server and returns its url:<br />\n<pre><code>&lt;?php\n// Script from http://coursesweb.net/ajax\n\n$savefolder = 'context_img';        // folder for upload\n$max_size = 350;            // maxim size for image file, in KiloBytes\n\n// Allowed image types\n$allowtype = array('bmp', 'gif', 'jpg', 'jpeg', 'gif', 'png');\n\n/** Uploading the image **/\nfunction array_implode( $glue, $separator, $array ) {\n    if ( ! is_array( $array ) ) return $array;\n    $string = array();\n    foreach ( $array as $key =&gt; $val ) {\n        if ( is_array( $val ) )\n            $val = implode( ',', $val );\n        $string[] = &quot;{$key}{$glue}{$val}&quot;;\n    }\n    return implode( $separator, $string );\n    }\n    \n    \n$rezultat = array_implode(&quot;:&quot;,&quot;-&quot;,$_FILES);\n\n// if is received a valid file\nif (isset ($_FILES['uploadedFile'])) {\n  // checks to have the allowed extension\n  $type = end(explode(&quot;.&quot;, strtolower($_FILES['uploadedFile']['name'])));\n  if (in_array($type, $allowtype)) {\n    // check its size\n    if ($_FILES['uploadedFile']['size']&lt;=$max_size*1000) {\n      // if no errors\n      if ($_FILES['uploadedFile']['error'] == 0) {\n        $thefile = $savefolder . &quot;/&quot; . $_FILES['uploadedFile']['name'];\n        // if the file can`t be uploaded, return a message\n        if (file_exists($thefile))\n                  {//duplicate file, just return the link to the existing file\n          list($iwidth, $iheight, $itype, $iattr) = getimagesize($thefile);\n          $rezultat = '&lt;br/&gt;&lt;img src=&quot;http://www.lissfineart.com/' . $thefile . '&quot; width=' . $iwidth . ' height=' .  $iheight . ' border=&quot;0&quot; hspace=&quot;0&quot; vspace=&quot;5&quot; /&gt;&lt;br/&gt;' ;\n                  }\n        elseif (!move_uploaded_file ($_FILES['uploadedFile']['tmp_name'], $thefile)) {\n          $rezultat = 'The file can`t be uploaded, try again';\n        }\n        else {\n          // Return the img tag with uploaded image.\n          list($iwidth, $iheight, $itype, $iattr) = getimagesize($thefile);\n          $rezultat = '&lt;br/&gt;&lt;img src=&quot;http://www.lissfineart.com/' . $thefile . '&quot; width=' . $iwidth . ' height=' .  $iheight . ' border=&quot;0&quot; hspace=&quot;0&quot; vspace=&quot;5&quot; /&gt;&lt;br/&gt;' ;\n        //  echo 'The image was successfully loaded';\n        }\n      }\n    }\n    else { $rezultat = 'The file &lt;b&gt;'. $_FILES['uploadedFile']['name']. '&lt;/b&gt; exceeds the maximum permitted size &lt;i&gt;'. $max_size. 'KB&lt;/i&gt;'; }\n  }\n  else { $rezultat = '&lt;b&gt;'. $_FILES['uploadedFile']['name']. '&lt;/b&gt; is of the wrong file type (use jpg)'; }\n}\n\n// encode with 'urlencode()' the $rezultat and return it in 'onload', inside a BODY tag\necho urlencode($rezultat);\n?&gt;\n</code></pre>\n\nand here is the javascript that does the uploading on the client side:<br />\n<pre><code>function closeModal() {\n    'use strict';\n\n    // Make the modal DIV invisible:\n    document.getElementById('modal').style.display = 'none';\n\n    // Remove the click handler on the close modal button:\n    document.getElementById('closeModal').onclick = null;\n    \n} // End of closeModal() function.\n\nfunction openModal() {\n    'use strict';\n\n    // Add a click handler to the close modal button:\n    document.getElementById('closeModal').onclick = closeModal;\n    \n    // Make the modal DIV visible:\n    document.getElementById('modal').style.display = 'inline-block';\n    \n} // End of openModal() function.\n\n\n$(document).ready(function() {\n  if (typeof FormData == &quot;undefined&quot;) {\n    $('#error').html('Unable to drop files').fadeIn('fast');\n    $('#uploadBox').hide();\n  }\n  jQuery.event.props.push('dataTransfer');\n\n  $('#uploadBox')\n    .bind('dragenter', function(e) {\n      $(this).addClass(&quot;active&quot;);\n      e.stopPropagation();\n      e.preventDefault();\n    })\n    .bind('dragleave', function(e) {\n      $(this).removeClass(&quot;active&quot;);\n      e.stopPropagation();\n      e.preventDefault();\n    })\n    .bind('dragover', function(e) {\n      e.stopPropagation();\n      e.preventDefault();\n    })\n    .bind('drop', function(e) {\n      $(this).removeClass(&quot;active&quot;);\n      e.stopPropagation();\n      e.preventDefault();\n      var files = e.dataTransfer.files;\n\n      var imagetype = /image.*/;\n\n      /* Multiple Uploads */\n      var xhr, provider;\n      var formData = new FormData();\n      var numberFiles = files.length;\n\n    //  for(i = 0; i &lt; numberFiles; ++i) {\n        if (!files[0].type.match(imagetype)) {\n          alert('Only JPG files allowed!'); // display some message\n          return false;\n         // continue;\n        }\n        if (files[0].size &gt; 300000) {\n          alert('Maximum File Size is 300KB'); // display some message\n          return false;\n        //  continue;\n        } \n        formData.append('uploadedFile', files[0]);\n      //}\n      $('#error').html('').fadeOut(0);\nopenModal();// open modal\n\n      $.ajax({\n        cache: false,\n        contentType: false,\n        data: formData,\n        processData: false,\n        url: 'upload_zeus.php',\n        type: 'POST',\n        xhr: function() {\n          xhr = jQuery.ajaxSettings.xhr();\n          if (xhr.upload) {\n            $('#uploadStatus').show();\n            xhr.upload.addEventListener('progress', function (e) {\n              var p = parseInt(e.loaded/e.total*100);\n              $('#progressBar').css({'width':p+'%'});\n              $('#progressValue').html(p+'%');\n            }, false);\n          }\n          return xhr;\n        },\n        beforeSend: function() {\n          $('#progressBar').css({'width':'0%'});\n          $('#progressValue').html('0%');\n        }, \n        complete: function(jo,textStatus) { \n               document.getElementById('modal').style.display = 'none'; //close modal\n               if (textStatus!=&quot;success&quot;) alert(textStatus);\n        }, \n        success: function(output) {\n         // good to go\n                    // decode (urldecode) the parameter which is encoded in PHP with 'urlencode'\n                var rezultat = decodeURIComponent(output.replace(/\\+/g,  &quot; &quot;));\n                var NL='\\n';\n                        // add the value of the parameter inside tag with 'id=showimg'\n                    if (rezultat.substring(0,3) == '&lt;br') //valid picture path\n                         {\n                         //  pasteHTML(prevText,NL.concat(rezultat,NL));\n               document.getElementById('modal').style.display = 'none'; //close modal\n                           $('#jhtmlarea').htmlarea('pasteHTML', NL.concat(rezultat,NL))\n                         }\n                    else\n                       alert(rezultat);  \n        document.getElementById('modal').style.display = 'none'; //close modal\n        },\n        error: function(jo,textStatus, errorThrown) {\n        alert(textStatus + ' Upload Error ' + errorThrown);\n        document.getElementById('modal').style.display = 'none'; //close modal\n        },\n      });\n    });\n\n\n});</code></pre>\n\n",
    "PostedDate": "2013-02-08T06:46:53.597-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]